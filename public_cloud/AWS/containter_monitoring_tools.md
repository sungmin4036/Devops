- [프로메테우스](#prometheus)
  
- [데이터톡(Datadog)](#Datadog)

- [뉴 렐릭(New Relic)](#New-Relic)

- [그라파나(Grafana)](#Grafana)

- [키바나(Kibana)](#Kibana)

- [크로노그래프(Chronograf)](#Chronograf)

- [Thanos](#Thanos)

- [Amazon Kinesis Data Firehose란?](#Amazon-Kinesis-Data-Firehose)

---

그라파나와 데이터독 같은 클라우드 모니터링 서비스는 메트릭 데이터를 시각화하고 대시보드를 구성할 수 있다는 점에서 비슷한 특징을 가지고 있습니다.

 또한 다양한 추가 기능한 외부 통합 기능을 통해 모니터링의 영역을 확장해나가고 있습니다.

가장 큰 차이점을 꼽아보자면, 데이터독의 경우 데이터를 직접 저장하고 있는 것과 달리 그라파나는 외부 데이터 소스를 정의하고 해당 데이터 소스에 쿼리를 통해서 데이터를 동적으로 가지고 와서 시각화를 한다는 점입니다.

예를 들어 데이터독에서 AWS 서비스를 연동하면 클라우드 와치의 메트릭 데이터를 일정 주기로 가져와서 데이터독 데이터베이스에 저장해둡니다.

이 때문에 데이터독을 사용하는 경우 클라우드와치의 실시간 데이터와 15분 정도의 약간의 시차가 발생합니다.

 반면에 그라파나는 AWS 클라우드 와치에 직접 쿼리해서 데이터를 가져오기 때문에 대시보드를 조회하는 동안 최신 데이터를 확인할 수 있습니다.

데이터독은 모니터링 서비스를 제공하는 상용 서비스이고, 그라파나는 오픈소스 프로젝트입니다. 

데이터독과 비교하기에 좀 더 적절한 서비스는 그라파나 자체보다는 그라파나 클라우드 서비스라고 할 수 있습니다. 그라파나 클라우드에서는 메트릭(프로메테우스)과 로그 데이터(로키)를 저장하고 사용할 수 있습니다.

---

### 라파나 클라우드(Grafana Cloud)와 그라파나 엔터프라이즈(Grafana Enterprise)

그라파나는 오픈소스로 기본적으로는 직접 설치하고 운영해야합니다. 또한 메트릭 데이터나 로그 데이터에 대한 관리도 직접해야한다는 불편함이 있습니다. 

그라파나 랩에서는 그라파나를 서비스로 제공하는 그라파나 클라우드 서비스를 제공하고 있습니다. 

무료 플랜에서는 5개의 대시보드까지 생성해볼 수 있습니다. 

스탠다드(Standard) 이상의 플랜에서는 다중 유저 기능을 제공하며, 대시보드를 제한없이 생성할 수 있습니다. 

메트릭과 로그 데이터를 저장하는 기능을 제공합니다. 스토리지 비용은 별도로 발생하니 확인이 필요합니다.

---


여기서 사용하는 프로메테우스와 그라파나는 오픈 소스 도구입니다.

오픈 소스는 가능한 한 단일 도구에서 단일 기능만을 구현하는 것을 선호합니다.

데이터 수집과 통합, 시각화는 서로 다른 영역이므로 이를 함꼐 구현하지 않으려는 경향이 있습니다.

물론 서비스형 모니터링 도구는 사용자 편의를 위해 이러한 기능을 모아서 한꺼번에 제공합니다.

그런데 왜 하나의 도구로 처리하지 않고 이런 혼합 구조를 사용할까요?

프로메테우스와 그라파나의 혼합 구조를 사용하는 이유는 크게 두 가지입니다.

- 비용 : 모니터링 대상마다 라이선스(License) 관련 비용이 발생하고, 클라우드 같은 과금제 서비스를 이용하면 네트워크와 저장 공간에 따른 추가 비용이 발생합니다.
- 보안 : 서비스형 모니터링 도구들은 대부분 외부에 데이터를 저장해 모니터링합니다. 보안에 민감해서 내부에서 모든 데이터를 처리하려는 경우에는 사용하기 어렵습니다.

그럼 다른 데이터 수집과 통합, 시각화에 사용하는 도구들은 무엇이 있을까요?

데이터 수집과 통합 도구

여러 모니터링 도구를 비교하며 프로메테우스를 선택한 이유를 알아보겠습니다.

---

#### Prometheus
- 사운드클라우드(SoundCloud)에서 자사 서비스의 모니터링을 위해 개발한 도구

현재는 오픈 소스로 전환돼 CNCF에서 관리, 2018년 8월 졸업 프로젝트가 됨

시계열 DB를 내장하고 있고, 자체적인 질의 페이지 외에 시각화 기능은 없으나 그라파나와 연계하면 현업에서 사용할 수 있는 시각화 기능 제공 가능

중앙 서버에서 에이전트의 데이터를 수집하는 풀(Pull) 방식을 사용하므로 쿠버네티스 환경에서 설치된 에이전트를 통해 노드와 컨테이너 상태를 모두 수집해 모니터링 가능

에이전트를 통해 내부 메트릭을 외부로 노출하기 때문에 사용자가 수집 대상에 접속할 수만 있다면 개인 컴퓨터에서도 메트릭을 가져올 수 있음, 따라서 모니터링과 관련된 개발을 하기 용이함

일회성으로 모니터링 대상에 대한 세부적인 메트릭도 간단하게 웹 브라우저로 확인 가능

완전한 오픈 소스 모델을 선택해 사용자 층이 넓고 자료가 풍부하며 각종 대시보드 도구나 메신저 등이 프로메테우스와의 연계를 지원하므로 직접 모니터링 시스템을 구축할 때 좋음



---

#### Datadog
- 모니터링 데이터를 업체에서 관리하는 경우를 서비스형이라고 하고, 데이터를 사용자가 직접 관리하는 경우를 설치형이라고 하는데, 데이터독은 서비스형 소프트웨어(SaaS) 형태로 제공

웹사이트에서 모니터링 대상을 관리할 수 있고 쿠버네티스를 비롯해 여러 클라우드 서비스나 애플리케이션과 연결이 쉬우므로 관리 부담이 적음
모니터링 대상마다 요금을 부과하기 때문에 모니터링 대상이 늘면 비용이 커지는 단점이 존재

---

#### New Relic

- 데이터독과 같은 Saas, 다만 데이터독과 비교했을 때 애플리케이션 성능 모니터링(APM, Application Performance Monitoring)에 더 특화됌

데이터독과 마찬가지로 모니터링 대상이 많을수록 비용 증가
인플럭스DB(InfluxDB)
- 2013년 인플럭스데이터(InFluxdata)에서 개발한 시계열 DB

오픈소스로 공개된 무료 버전과 클라우드에서 바로 사용할 수 있는 SaaS, 라이선스를 구매해 설치할 수 있는 엔터프라이 버전, 총 3가지 유형을 제공
무료 버전은 프로메테우스와 유사하지만 인플럭스DB가 쓰기 성능이 더 뛰어나 대량의 이벤트를 모니터링하는 데는 좀 더 적합
엔터프라이즈 버전은 프로메테유스에서 부족한 부분인 고가용성을 위한 분산 저장을 좀 더 쉽게 구성할 수 있는 기능 제공
프로메테우스와 더불어 오픈 소스로 모니터링 플랫폼을 구축하기 위한 최선의 도구이고, 유료 서비스도 있어 선택의 폭이 좀 더 넓음
하지만 간단한 구성으로 데이터를 받아오는 프로메테우스보다 상대적으로 구성이 어렵다는 단점이 존재

```
메트릭이란?
메트릭(Metric)은 간단히 말해 현재 시스템의 상태를 알 수 있는 측정값입니다.
컨테이너 인프라 환경에서는 크게 2가지 상태로 메트릭을 구분합니다.
파드 같은 오브젝트에서 측정되는 CPU와 메모리 사용량을 나타내는 시스템 메트릭(System Metric),
HTTP 상태 코드 같은 서비스 상태를 나타내는 지표인 서비스 메트릭(Service Metric) 입니다.
```

```
시계열 데이터베이스란?
시계열 DB는 시간을 축(키)으로 시간의 흐름에 따라 발생하는 데이터를 저장하는 데 최적화된 데이터베이스입니다.
예를 들어 네트워크 흐름을 알 수 있는 패킷과 각종 기기로부터 전달받는 IoT 센서 값, 이벤트 로그 등이 있습니다.
이 책에서는 프로메테우스의 시계열 DB에 쿠버네티스와 노드에서 공개하는 메트릭을 저장하고,
이를 효과적으로 조합해 사용자가 원하는 모니터링을 구성합니다.
```

![image](https://user-images.githubusercontent.com/62640332/156409255-0eb55ffd-94cc-4376-b301-903392c875e0.png)

---

### 데이터 시각화 도구
프로메테우스와 인플럭스DB가 제공하는 대시보드는 서비스형으로 사용하는 데이터톡과 뉴 렐릭보다 시각화 부분이 다소 약합니다.

그래서 부족한 시각화 기능을 보강하는 다음과 같은 도구를 사용합니다.

---

#### Grafana
- 그라파나 랩스(Grafana Labs)에서 개발했으며, 특정 소프트웨어에 종속되지 않은 독립적인 시각화 도구
- 30가지 이상의 다양한 수집 도구 및 DB들과 연계를 지원
- 주로 시계열 데이터 시각화에 많이 쓰임, 관계형 데이터베이스 데이터를 표 형태로 시각화해 사용할 수도 있음
- 기능을 확장하는 플러그인과 개별 사용자들이 만들어 둔 대시보드의 공유가 매우 활발
- 오픈 소스라서 사용자의 요구 사항에 맞게 수정 가능, 필요에 따라 설치형과 서비스형 모두 선택 가능


---

#### Kibana
- 엘라스틱서치(ElasticSearch)를 개발한 엘라스틱에서 만든 시각화 도구
- 엘리스틱서치에 적재된 데이터를 시각화하거나 검색하는 데 사용, 이러한 데이터를 분석할 때도 사용
- 엘라스틱서치의 데이터만을 시각화할 수 있기 때문에 프로메테우스의 시계열 데이터를 메트릭비트(Metricbeat)라는 도구로 엘라스틱서치에 전달해야 하는 불편함 존재
- 시각화 기능이 매우 강력해서 시각화를 중점적으로 다루는 경우에는 고려해볼만 함

---

#### Chronograf
- 인플럭스DB를 개발한 인플럭스데이터에서 만든 시각화 도구
- 오픈소스로 제공돼 사용자 편의에 맞게 수정 가능
- 설치형과 서비스형 모두 제공
- 키바나와 마찬가지로 자사 제품인 인플럭스DB만 시각화할 수 있으므로 다양한 대상을 시각화할 수 없음

![image](https://user-images.githubusercontent.com/62640332/156409348-bf00f788-af95-440c-9f42-27a90b5307a4.png)

엘라스틱 제품들을 설치형으로 구성하면 무료로 사용할 수 있지만, 엘라스틱서치로 저장해야 해서 필요한 도구가 늘어납니다.

우리는 자유도가 높은 오픈 소스를 활용해 컨테이너 인프라 환경을 구현하고 실습하는 것이 목적이므로 기능이 부족하지 않고,

확장성도 뛰어난 프로메테우스와 그라파나의 조합으로 모니터링 시스템을 구축하겠습니다.


---

### Thanos

문제 정의 
프로메테우스가 좋은 모니터링 시스템이긴 하지만 두가지 결정적인 문제점을 가지고 있다. 결정적으로 클러스터링 구조를 지원하지 않기 때문에, 확장성과 가용성 문제를 가지고 있다. 

확장성 측면에서는 디스크를 증설하거는 것과 같은 하드웨어 스펙 증설로 어느정도는 해결이 가능하지만 데이타 볼륨이 늘어나고 모니터링 대상이 늘어나면 하나의 프로메테우스 인스턴스로는 감당이 어렵다. 

이런 문제를 해결하는 방법으로는 Federation 이라는 방법을 사용한다. 프로메테우스 인스턴스를 여러개를 기동한 다음에, 중앙에 다른 프로메테우스로 부터 메트릭을 수집하는 다른 프로메테우스를 놓는 방식이고,

 데이타 양에 대한 문제는 데이타의 해상도 (예를 들어 전면에 데이타 수집 서버가 10초 단위로 수집 했다면, 중앙 서버에서는 1분 단위로 수집 한다는 등)를 줄이거나 평균이나 합과 같은 대표값을 사용해서 해결할 수 있다. 

![image](https://user-images.githubusercontent.com/62640332/156411260-f5507b08-f42f-4ddc-9d56-206e7dd90aa7.png)

다른 문제로는 가용성 문제를 들 수 있다. 

프로메테우스는 하나의 서버로 기동되기 때문에 그 서버가 장애로 내려가거나 또는 패치나 서버 리스타트와 같은 유지보수 업무에 의해서 프로메테우스 서버가 내려가더라도 그 시간동안에는 매트릭을 수집할 수 없다는 단점을 가지고 있다. 

클러스터링 기능이 없기 때문에 이를 해결하기 위해서는 프로메테우스 인스턴스를 두개 이상 띄운 다음에 같은 대상 시스템으로 부터 매트릭을 수집하는 방식인데, 이렇게 하면, 한 서버가 내려가더라도 다른 서버에 매트릭정보가 수집이 된다.

![image](https://user-images.githubusercontent.com/62640332/156411387-a7809230-b3d1-4e44-954c-fa1494bd8bc4.png)

그래서 이런 문제를 해결하기 위한 오픈소스가 타노스이다.

기본적인 구조는 다음과 같은 컨셉이다.

![image](https://user-images.githubusercontent.com/62640332/156411448-1a42dba9-7446-4cb8-b60f-bb93b42c428a.png)

여러개의 프로메테우스로 부터 매트릭을 조합해서 타노스에서 전체 프로메테우스의 메트릭을 볼 수 있도록 해주고, 수집된 메트릭을 스케일이 가능한 스토리지에 저장해서 특정 프로메테우스 인스턴스가 다운이 되더라도 그 인스턴스가 담당하는 메트릭을 조회할 수 있도록 해준다. 



개념 이해를 돕기 위해서 아키텍쳐를 살펴보자

- Thanos Side car & Querier
  
먼저 데이타 수집과 쿼리 방식을 보면, 프로메테우스 서버에 타노스 에이전트가 인스톨 되서 데이타를 조회할 수 있게 해준다. 

프로메테우스는 데이타를 로컬 디스크에 저장하기 때문에 타노스 에이전트 (Thanos Sidecar : 마이크로 서비스 아키텍쳐 패턴중 사이드카 패턴을 사용하기 때문에, 타노스 사이드카라고 부른다.)는

디스크에 저장된 내용을 읽어서 필요시에 쿼리 엔진 (Thanos Querier)에 전달한다. 

여러개의 프로메테우스 인스턴스가 있더라도, 각 프로메테우스 마다 사이드카 에이전트가 설치되서 쿼리 엔진에 전달하기 때문에 

사용자 입장에서는 하나의 타노스 쿼리 엔진(UI)만 가지고도 전체 프로메테우스를 통해서 모든 모니터링 대상의 메트릭을 조회할 수 있도록 되는 것이다. 


![image](https://user-images.githubusercontent.com/62640332/156411503-5f29fbee-77e0-421a-beb9-96a3f45f56fd.png)

- HA 지원

기본적인 HA 지원 방식은 기존 방식과 다르지 않다. 아래 그림과 같이 프로메테우스 인스턴스를 동시에 두개를 띄워서 같은 모니터링 대상을 모니터링 해서 각각의 지표를 저장하는 방식이다


![image](https://user-images.githubusercontent.com/62640332/156411580-8dd274ca-5a41-4f58-a473-f0f6db93b656.png)

그러면 타노스로 인해 오는 장점은 무엇인가? 

기존 방식의 경우에는 프로메테우스 인스턴스 각각의 메트릭으로 모니터링 해야 하지만 타노스는 특정 그룹의 프로메테우스 인스턴스들의 지표들의 하나의 인스턴스로 처리해서 메트릭을 보여준다.

즉 두개의 인스턴스에서 수집된 메트릭을 합쳐서(merge) 해서 볼 수 있도록 해주고, 당연히 같은 모니터링 대상을 모니터링 하기 때문에 중복되는 메트릭 값이 있을 수 있는데, 이 중복 값을 제거 해주는 De-duplication 기능을 가지고 있다. 

- 오랜된 값 저장

앞에서 언급은 하지 않았지만 프로메테우스의 다른 문제점 중의 하나는 로컬 디스크를 사용하기 때문에 일정 기간이 지난 오래된 데이터는 삭제가 된다. 그래서 오래된 데이터에 대한 조회가 불가능하다. 

타노스 입장에서는 오래된 데이터 저장 문제 뿐만 아니라 여러 프로메테우스를 동시에 모니터링 하게 되면 마찬가지로 메모리와 로컬 디스크의 용량 문제로 인해서 여러 프로메테우스를 모니터링 할 수 없는 문제가 발생하는데,

이를 해결하기 위해서 타노스는 외부 스토리지를 사용한다. 


프로메테우스에서 수집된 데이타는 2시간 정도 메모리에 저장이 되었다가 로컬 디스크로 덤프가 된다. 저장된 파일을 타노스 에이전트가 수집해서 외부 스토리지에 저장한다.

외부 스토리지는 Ceph와 같은 분산형 파일 시스템이나 Google Cloud Storage, AWS S3와 같은 클라우드 오브젝트 스토리지를 사용한다. 

그리고 쿼리 엔진에서 근래의 데이타를 조회할때는 프로메테우스 인스턴스에 설치된 타노스 사이드카 에이전트를 통하지만 오래된 데이터는 스토리지에 저장된 데이터는 Thano Storage Gateway라는 컴포넌트를 통해서 조회된다.

이 컴포넌트는 스토리지에 저장된 데이타를 Storage API를 통해서 쿼리엔진과 통신 하는 역할을 한다.

Gateway는 단순 쿼리를 API로 저장하는 역할뿐만 아니라 중간에 캐쉬를 제공하여, 빠른 응답 시간을 제공한다.


![image](https://user-images.githubusercontent.com/62640332/156411732-e522ce92-88a5-4017-ab3c-82c7d49b71c8.png)

이 구조를 이용함으로써 메트릭 데이터의 보관 주기를 늘릴 수 있게 된다. 

스토리지에 저장된 메트릭을 장기 보관하게 되면, 디스크 용량에 대한 문제도 있지만 아주 오래된 데이타(1~2년전)의 데이터를 조회하고자 하면, 많은 데이터를 스캔해야하기 때문에 성능에 있어서 많은 문제가 생길 수 있다.

그래서 스토리지에 저장된 데이타를 관리하는 컴포넌트로 Compactor 라는 컴포넌트가 있다.

기본적으로 데이타 파일을 압축할 뿐만 아니라, 다운 샘플링을 하는데,

다운 샘플링이란, 매트릭이 1분 단위로 샘플링 되었다면, 10분이나 1시간 단위로 샘플링 기준을 다운해서 (해상도를 낮춰서) 전체 데이타 저장 용량을 낮추는 방법이다. 

사실 프로메테우스의 한계를 해결하기 위해서 오픈소스 쪽에서 타노스가 좋은 솔루션이기는 하지만, 개인적으로 운영환경에 올린다면 이렇게 복잡한 설정 대신 프로메테우스를 앞에 놓고 (구글 클라우드 엔지니어니까는) 뒤에 타노스 대신 구글 스택 드라이버를 놓는 것이 여러모로 편하겠다는 생각은 좀 든다

---

### Amazon Kinesis Data Firehose

실시간 데이터 스트림을 준비하여 데이터 스토어 및 분석 서비스로 로드

: 스트리밍 데이터를 데이터 레이크, 데이터 스토어 및 분석 서비스에 안정적으로 로드하는 가장 쉬운 방법

- 스트리밍 데이터를 캡처하고 변환

- Amazon S3, Redshift, Elasticsearch Service, 일반 HTTP 엔드포인트 및 Datadog, New Relic, MongoDB, Splunk와 같은 서비스 공급자로 전송

- 데이터 처리량에 대응하여 자동으로 확장됨

- 지속적인 관리가 필요 없는 완전 관리형 서비스

- 데이터 스트림 로드 전 배치 처리, 압축, 변환 및 암호화하여 스토리지의 사용량 최소화, 보안 강화

Amazon Kinesis Data Firehose Firehose는 실시간 전송을 위한 완전관리형 서비스입니다.

AWS Kinesis 는 데이터 수집구간과 데이터 처리구간 중간에 위치합니다.
이렇게 중간에 위치하는 소프트웨어를 만든 이유는 다양한 데이터들을 수집하고 이것을 다양한 포맷으로 만들어 줍니다.

Kinesis 를 이해하는데 헷깔리는게 있는데, Kinesis 가 ‘스트리밍 데이터 처리’ 를 해준다는 것입니다.

여기서 스트리밍 데이터 처리라는 말은 스트리밍으로 데이터를 분석해준다는 이야기가 아닙니다.

다양한 형태로 들어오는 데이터를 가공해서 다양한 분석 소프트웨어가 사용가능하도록 다양한 출력물을 만들어내주거나 데이터 저장소에 저장하도록 해줍니다.

Kinesis Data Firehose Firehose를 사용하면 애플리케이션을 쓰거나 리소스를 관리할 필요가 없습니다.

Kinesis Data Firehose로 데이터를 보내도록 데이터 생산자를 구성하면 지정한 대상으로 데이터를 자동으로 전송합니다.

전송 전에 Kinesis Data Firehose Firehose를 구성하여 데이터를 변환할 수도 있습니다.
